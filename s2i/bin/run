#!/bin/bash -x

readonly WP_BASE_DIR=/opt/app-root/src

echo "-> Installing base Wordpress plugins and themes onto Persistent Volume ..."
cp -R wp-content-install/* wp-content/

echo "-> Installing user provided wp-content onto Persistent Volume ..."
cp -fR wp-content-user/* wp-content/

# Setup defaults
export WORDPRESS_TABLE_PREFIX=${WORDPRESS_TABLE_PREFIX:-"wp_"}
export WORDPRESS_DEBUG=${WORDPRESS_DEBUG:-"false"}
export WORDPRESS_MULTISITE=${WORDPRESS_MULTISITE:-"false"}
export WORDPRESS_AUTH_KEY=${WORDPRESS_AUTH_KEY:-"8kbs6rtoD2siI1gwk0laCcu6LSkN+Ja6QFeUMaX"}
export WORDPRESS_SECURE_AUTH_KEY=${WORDPRESS_SECURE_AUTH_KEY:-"83kbs6rD2siI1gwk0laHSCcu6LSkN+Ja6QFeUMaX"}
export WORDPRESS_LOGGED_IN_KEY=${WORDPRESS_LOGGED_IN_KEY:-"83kbs6rt2siI1gwk0laHSCcu6LSkN+Ja6QFeUMaX"}
export WORDPRESS_NONCE_KEY=${WORDPRESS_NONCE_KEY:-"83kbs6rtoD2siI1gwk0laHSCcu6LSkN+Ja6eUMaX"}
export WORDPRESS_AUTH_SALT=${WORDPRESS_AUTH_SALT:-"83kbs6rtoD2siI1gwk0laHSCcu6LSkN+Ja6QFeaX"}
export WORDPRESS_SECURE_AUTH_SALT=${WORDPRESS_SECURE_AUTH_SALT:-"83kbs6rtoD2siI1gwk0laH6LSkN+Ja6QFeUMaX"}
export WORDPRESS_LOGGED_IN_SALT=${WORDPRESS_LOGGED_IN_SALT:-"83kbs62siI1gwk0laHSCcu6LSkN+Ja6QFeUMaX"}
export WORDPRESS_NONCE_SALT=${WORDPRESS_NONCE_SALT:-"83s6rtoD2siI1gwk0laHSC6LSkN+Ja6QFeUMaX"}

echo "-> Generated new wp-config.php file ..."

# Completize configuration
if [ -f ${WP_BASE_DIR}/wp-config.php ]; then
  grep -q "^?>" ${WP_BASE_DIR}/wp-config.php 2>/dev/null && echo "<?php" >>${WP_BASE_DIR}/wp-config.php
else
  cat wp-config.php.template >> ${WP_BASE_DIR}/wp-config.php
fi

[[ -n "${WORDPRESS_DB_NAME}" ]]      && echo "define('DB_NAME',             getenv('WORDPRESS_DB_NAME'));"     >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_DB_USER}" ]]      && echo "define('DB_USER',             getenv('WORDPRESS_DB_USER'));"     >>${WP_BASE_DIR}/wp-config.php 
[[ -n "${WORDPRESS_DB_PASSWORD}" ]]  && echo "define('DB_PASSWORD',         getenv('WORDPRESS_DB_PASSWORD'));" >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_DB_HOST}" ]]      && echo "define('DB_HOST',             getenv('WORDPRESS_DB_HOST'));"     >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_DB_HOST}" ]]      && echo "define('DB_CHARSET',          'utf8'                     );"     >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_DB_HOST}" ]]      && echo "define('DB_COLLATE',          ''                         );"     >>${WP_BASE_DIR}/wp-config.php
[[ -n "${AUTH_KEY}" ]]               && echo "define('AUTH_KEY',            getenv('AUTH_KEY'));"              >>${WP_BASE_DIR}/wp-config.php
[[ -n "${SECURE_AUTH_KEY}" ]]        && echo "define('SECURE_AUTH_KEY',     getenv('SECURE_AUTH_KEY'));"       >>${WP_BASE_DIR}/wp-config.php
[[ -n "${LOGGED_IN_KEY}" ]]          && echo "define('LOGGED_IN_KEY',       getenv('LOGGED_IN_KEY'));"         >>${WP_BASE_DIR}/wp-config.php
[[ -n "${NONCE_KEY}" ]]              && echo "define('NONCE_KEY',           getenv('NONCE_KEY'));"             >>${WP_BASE_DIR}/wp-config.php
[[ -n "${AUTH_SALT}" ]]              && echo "define('AUTH_SALT',           getenv('AUTH_SALT'));"             >>${WP_BASE_DIR}/wp-config.php
[[ -n "${SECURE_AUTH_SALT}" ]]       && echo "define('SECURE_AUTH_SALT',    getenv('SECURE_AUTH_SALT'));"      >>${WP_BASE_DIR}/wp-config.php
[[ -n "${LOGGED_IN_SALT}" ]]         && echo "define('LOGGED_IN_SALT',      getenv('LOGGED_IN_SALT'));"        >>${WP_BASE_DIR}/wp-config.php
[[ -n "${NONCE_SALT}" ]]             && echo "define('NONCE_SALT',          getenv('NONCE_SALT'));"            >>${WP_BASE_DIR}/wp-config.php
[[ -n "${DOMAIN_CURRENT_SITE}" ]]    && echo "define('DOMAIN_CURRENT_SITE', getenv('DOMAIN_CURRENT_SITE'));"   >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_HOME}" ]]         && echo "define('WP_HOME',             getenv('WORDPRESS_HOME'));"        >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_SITEURL}" ]]      && echo "define('WP_SITEURL',          getenv('WORDPRESS_SITEURL'));"     >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_DEBUG}" ]]        && echo "define('WP_DEBUG',            getenv('WORDPRESS_DEBUG'));"       >>${WP_BASE_DIR}/wp-config.php
[[ -n "${WORDPRESS_TABLE_PREFIX}" ]] && echo "\$table_prefix  = '${WORDPRESS_TABLE_PREFIX}';"                  >>${WP_BASE_DIR}/wp-config.php

# multisite support
if ${WORDPRESS_MULTISITE}; then
  echo "Enabling multisite functionality..."
  [[ -z "${WORDPRESS_DOMAIN_CURRENT_SITE}" ]] && echo "The WORDPRESS_DOMAIN_CURRENT_SITE variable must be set." && exit 1
  [[ -z "${WORDPRESS_HOME}" ]] && echo "The WORDPRESS_HOME variable must be set." && exit 1  
  [[ -z "${WORDPRESS_SITEURL}" ]] && echo "The WORDPRESS_SITEURL variable must be set." && exit 1   
  cat <<EOF >> ${WP_BASE_DIR}/wp-config.php
define( 'WP_ALLOW_MULTISITE', true );
define('MULTISITE', true);
define('SUBDOMAIN_INSTALL', false);
define('PATH_CURRENT_SITE', '/');
define('SITE_ID_CURRENT_SITE', 1);
define('BLOG_ID_CURRENT_SITE', 1);
EOF
fi

if ${WORDPRESS_DEBUG}; then
  echo "Wordpress debug enabled....."
  echo "wp-config:"
  cat ${WP_BASE_DIR}/wp-config.php
fi
echo -e "-> Wordpress is now configured!\n"
exec ${STI_SCRIPTS_PATH}/run-base
